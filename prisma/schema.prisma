// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int                 @id @default(autoincrement())
  email           String              @unique
  password        String
  createdAt       DateTime            @default(now())
  programs        ProgramAssignment[]
  createdPrograms Program[]           @relation("ProgramCreatedBy")
}

model Program {
  id            String              @id @default(cuid())
  name          String
  year          Int
  createdBy     User                @relation("ProgramCreatedBy", fields: [createdById], references: [id])
  createdById   Int
  assignments   ProgramAssignment[]
  roles         ProgramRole[]
  years         ProgramYear[]
  groupingTypes GroupingType[]
  groupings     Grouping[]
  parties       Party[]
  positions     Position[]
  brandingContacts ProgramBrandingContact[]
  applications     Application[]
  emailConfig   EmailConfig?
  emailTemplates EmailTemplate[]
  status        String              @default("active")
  defaultVotingMethod String        @default("plurality") // plurality, majority, ranked
  createdAt     DateTime            @default(now())
}

model ProgramAssignment {
  id            Int          @id @default(autoincrement())
  user          User         @relation(fields: [userId], references: [id])
  userId        Int
  program       Program      @relation(fields: [programId], references: [id])
  programId     String
  role          String       // Legacy: "admin" or "member"
  programRole   ProgramRole? @relation(fields: [programRoleId], references: [id])
  programRoleId Int?
  createdAt     DateTime     @default(now())

  @@index([programRoleId])
}

model ProgramRole {
  id           Int                     @id @default(autoincrement())
  program      Program                 @relation(fields: [programId], references: [id])
  programId    String
  name         String
  description  String?
  isDefault    Boolean                 @default(false)
  isActive     Boolean                 @default(true)
  displayOrder Int?
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt

  permissions  ProgramRolePermission[]
  assignments  ProgramAssignment[]

  @@unique([programId, name])
  @@index([programId])
}

model ProgramRolePermission {
  id         Int         @id @default(autoincrement())
  role       ProgramRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId     Int
  permission String
  createdAt  DateTime    @default(now())

  @@unique([roleId, permission])
  @@index([roleId])
}

model Log {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  level     String
  source    String
  programId String
  message   String
  error     String?
}

model ProgramYear {
  id        Int                   @id @default(autoincrement())
  program   Program               @relation(fields: [programId], references: [id])
  programId String
  year      Int
  startDate DateTime?
  endDate   DateTime?
  status    String                @default("active")
  notes     String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  archivedAt DateTime?
  groupings ProgramYearGrouping[]
  parties   ProgramYearParty[]
  delegates Delegate[]
  staff     Staff[]
  parents   Parent[]
  programYearPositions ProgramYearPosition[]
  delegateParentLinks DelegateParentLink[]
  elections Election[]
}

model GroupingType {
  id          Int        @id @default(autoincrement())
  program     Program    @relation(fields: [programId], references: [id])
  programId   String
  defaultName String
  customName  String?
  pluralName  String?
  levelOrder  Int
  isRequired  Boolean    @default(false)
  status      String     @default("active")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  groupings   Grouping[]

  @@index([programId])
}

model Grouping {
  id               Int                   @id @default(autoincrement())
  program          Program               @relation(fields: [programId], references: [id])
  programId        String
  groupingType     GroupingType          @relation(fields: [groupingTypeId], references: [id])
  groupingTypeId   Int
  parentGrouping   Grouping?             @relation("GroupingToParent", fields: [parentGroupingId], references: [id])
  parentGroupingId Int?
  children         Grouping[]            @relation("GroupingToParent")
  name             String
  status           String                @default("active")
  displayOrder     Int?
  notes            String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  programYears     ProgramYearGrouping[]
  delegates        Delegate[]
  staff            Staff[]
  elections        Election[]

  @@index([programId])
  @@index([groupingTypeId])
  @@index([parentGroupingId])
}

model ProgramYearGrouping {
  id            Int         @id @default(autoincrement())
  programYear   ProgramYear @relation(fields: [programYearId], references: [id])
  programYearId Int
  grouping      Grouping    @relation(fields: [groupingId], references: [id])
  groupingId    Int
  status        String      @default("active")

  @@index([programYearId])
  @@index([groupingId])
}

model Party {
  id                 Int                @id @default(autoincrement())
  program            Program            @relation(fields: [programId], references: [id])
  programId          String
  name               String
  abbreviation       String?
  color              String?
  icon               String?
  status             String             @default("active")
  displayOrder       Int?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  programYearParties ProgramYearParty[]

  @@index([programId])
}

model ProgramYearParty {
  id            Int         @id @default(autoincrement())
  programYear   ProgramYear @relation(fields: [programYearId], references: [id])
  programYearId Int
  party         Party       @relation(fields: [partyId], references: [id])
  partyId       Int
  status        String      @default("active")
  delegates     Delegate[]
  electionCandidates ElectionCandidate[]
  elections     Election[]  // Primary elections for this party

  @@unique([programYearId, partyId])
  @@index([programYearId])
  @@index([partyId])
}

model Delegate {
  id            Int               @id @default(autoincrement())
  programYear   ProgramYear       @relation(fields: [programYearId], references: [id])
  programYearId Int
  firstName     String
  lastName      String
  email         String
  phone         String?
  userId        Int?
  grouping      Grouping?         @relation(fields: [groupingId], references: [id])
  groupingId    Int?
  party         ProgramYearParty? @relation(fields: [partyId], references: [id])
  partyId       Int?
  status        String            @default("active")
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  parentLinks   DelegateParentLink[]
  programYearPositions ProgramYearPosition[]
  votesCast     ElectionVote[] @relation("Voter")
  votesReceived ElectionVote[] @relation("Candidate")
  candidacies   ElectionCandidate[]

  @@index([programYearId])
  @@index([groupingId])
  @@index([partyId])
}

model Staff {
  id            Int         @id @default(autoincrement())
  programYear   ProgramYear @relation(fields: [programYearId], references: [id])
  programYearId Int
  firstName     String
  lastName      String
  email         String
  phone         String?
  userId        Int?
  role          String
  grouping      Grouping?   @relation(fields: [groupingId], references: [id])
  groupingId    Int?
  status        String      @default("active")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  nominations   ElectionCandidate[]

  @@index([programYearId])
  @@index([groupingId])
}

model Parent {
  id        Int         @id @default(autoincrement())
  programYear   ProgramYear @relation(fields: [programYearId], references: [id])
  programYearId Int
  userId    Int?
  firstName String
  lastName  String
  email     String
  phone     String?
  status    String      @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  links     DelegateParentLink[]

  @@index([programYearId])
}

model DelegateParentLink {
  id            Int         @id @default(autoincrement())
  delegate      Delegate    @relation(fields: [delegateId], references: [id])
  delegateId    Int
  parent        Parent      @relation(fields: [parentId], references: [id])
  parentId      Int
  programYear   ProgramYear @relation(fields: [programYearId], references: [id])
  programYearId Int
  status        String      @default("pending")
  createdAt     DateTime    @default(now())
  invitedByUserId Int?
  updatedAt     DateTime    @updatedAt

  @@index([delegateId])
  @@index([parentId])
  @@index([programYearId])
}

model Position {
  id            Int                @id @default(autoincrement())
  program       Program            @relation(fields: [programId], references: [id])
  programId     String
  name          String
  description   String?
  displayOrder  Int?
  status        String             @default("active")
  isElected     Boolean            @default(false)
  isNonPartisan Boolean            @default(false) // If true, no primary election (non-partisan race). Only applies to elected positions.
  groupingTypeId Int?
  ballotGroupingTypeId Int?        // Which level's ballot this position appears on (for elected positions)
  seatCount     Int                @default(1)
  requiresDeclaration Boolean      @default(false) // Whether candidates must formally declare candidacy
  requiresPetition Boolean         @default(false) // Whether candidates need petition signatures
  petitionSignatures Int?          // Number of signatures required (only if requiresPetition is true)
  electionMethod String?           // Override program default: 'plurality', 'majority', or 'ranked'. Null = use program default.
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  programYearPositions ProgramYearPosition[]

  @@index([programId])
  @@index([groupingTypeId])
  @@index([ballotGroupingTypeId])
}

model ProgramYearPosition {
  id            Int         @id @default(autoincrement())
  programYear   ProgramYear @relation(fields: [programYearId], references: [id])
  programYearId Int
  position      Position    @relation(fields: [positionId], references: [id])
  positionId    Int
  delegate      Delegate?   @relation(fields: [delegateId], references: [id])
  delegateId    Int?
  groupingId    Int?
  assignedDelegateId Int?
  assignedByStaffId Int?
  isElected    Boolean     @default(false)
  status        String      @default("active")
  // Year-specific overrides (nullable = inherit from base Position)
  isNonPartisan        Boolean? // Override for non-partisan status
  requiresDeclaration  Boolean? // Override for declaration requirement
  requiresPetition     Boolean? // Override for petition requirement
  petitionSignatures   Int?     // Override for petition signature count
  elections     Election[]

  @@index([programYearId])
  @@index([positionId])
  @@index([delegateId])
  @@index([groupingId])
  @@index([assignedDelegateId])
  @@index([assignedByStaffId])
}

model Election {
  id            Int                @id @default(autoincrement())
  programYear   ProgramYear        @relation(fields: [programYearId], references: [id])
  programYearId Int
  position      ProgramYearPosition @relation(fields: [positionId], references: [id])
  positionId    Int
  grouping      Grouping            @relation(fields: [groupingId], references: [id])
  groupingId    Int
  party         ProgramYearParty?   @relation(fields: [partyId], references: [id])
  partyId       Int?               // For primary elections: which party this primary is for
  electionType  String?            // "primary" or "general" (null for non-partisan single-round)
  status        String             @default("nomination") // nomination, scheduled, active, completed
  method        String?            // voting method (plurality, ranked, etc.)
  startTime     DateTime?
  endTime       DateTime?
  createdAt     DateTime           @default(now())
  votes         ElectionVote[]
  candidates    ElectionCandidate[]

  @@index([programYearId])
  @@index([positionId])
  @@index([groupingId])
  @@index([partyId])
  @@index([electionType])
}

model ElectionCandidate {
  id            Int         @id @default(autoincrement())
  election      Election    @relation(fields: [electionId], references: [id])
  electionId    Int
  delegate      Delegate    @relation(fields: [delegateId], references: [id])
  delegateId    Int
  party         ProgramYearParty? @relation(fields: [partyId], references: [id])
  partyId       Int?        // Required for primary elections
  nominatedBy   Staff?      @relation(fields: [nominatedByStaffId], references: [id])
  nominatedByStaffId Int?
  status        String      @default("nominated") // nominated, qualified, withdrawn, advanced, elected
  // Candidacy requirement tracking
  declarationReceived Boolean   @default(false) // Has declaration of candidacy been received?
  declarationReceivedAt DateTime?
  petitionVerified    Boolean   @default(false) // Has petition been verified?
  petitionSignatureCount Int?   // Actual number of valid signatures (if applicable)
  petitionVerifiedAt  DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([electionId, delegateId]) // A delegate can only be nominated once per election
  @@index([electionId])
  @@index([delegateId])
  @@index([partyId])
  @@index([nominatedByStaffId])
  @@index([status])
}

model ElectionVote {
  id                  Int      @id @default(autoincrement())
  election            Election @relation(fields: [electionId], references: [id])
  electionId          Int
  voter               Delegate @relation("Voter", fields: [voterDelegateId], references: [id])
  voterDelegateId     Int
  candidate           Delegate @relation("Candidate", fields: [candidateDelegateId], references: [id])
  candidateDelegateId Int
  voteRank            Int?
  createdAt           DateTime @default(now())
  createdByIp         String?
  isProvisional       Boolean?

  @@index([electionId])
  @@index([voterDelegateId])
  @@index([candidateDelegateId])
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  tableName  String
  recordId   String
  userId     Int
  action     String
  timestamp  DateTime @default(now())
  changes    Json?

  @@index([tableName])
  @@index([recordId])
  @@index([userId])
}

model ProgramBrandingContact {
  id                String   @id @default(cuid())
  program           Program  @relation(fields: [programId], references: [id])
  programId         String
  welcomeMessage    String?
  logoUrl           String?
  iconUrl           String?
  bannerUrl         String?
  colorPrimary      String?  @map("color_primary")
  colorSecondary    String?  @map("color_secondary")
  colorBackground   String?  @map("color_background")
  contactEmail      String?
  contactPhone      String?
  contactWebsite    String?
  contactFacebook   String?
  updatedAt         DateTime @updatedAt
  createdAt         DateTime @default(now())

  audits ProgramBrandingContactAudit[]

  @@index([programId])
}

model ProgramBrandingContactAudit {
  auditId           String   @id @default(cuid())
  brandingContact   ProgramBrandingContact? @relation(fields: [brandingContactId], references: [id])
  brandingContactId String?
  programId         String
  programName       String
  welcomeMessage    String?
  logoUrl           String?
  iconUrl           String?
  bannerUrl         String?
  colorPrimary      String? @map("color_primary")
  colorSecondary    String? @map("color_secondary")
  colorBackground   String? @map("color_background")
  contactEmail      String?
  contactPhone      String?
  contactWebsite    String?
  contactFacebook   String?
  updatedAt         DateTime?
  createdAt         DateTime?
  changeType        String
  changedByUserId   Int?
  changeReason      String?
  changedAt         DateTime @default(now())

  @@index([brandingContactId])
}

model EmailConfig {
  id            Int      @id @default(autoincrement())
  program       Program  @relation(fields: [programId], references: [id])
  programId     String   @unique
  smtpHost      String
  smtpPort      Int      @default(587)
  smtpUser      String
  smtpPass      String   // Encrypted in application layer
  fromEmail     String
  fromName      String?
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([programId])
}

model EmailTemplate {
  id            Int      @id @default(autoincrement())
  program       Program  @relation(fields: [programId], references: [id])
  programId     String
  templateType  String   // delegate_welcome, staff_welcome, etc.
  subject       String
  body          String   // HTML content with placeholders like {{firstName}}, {{programName}}
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([programId, templateType])
  @@index([programId])
}

model Application {
  id          String                @id @default(cuid())
  program     Program               @relation(fields: [programId], references: [id])
  programId   String
  year        Int?
  type        String?
  title       String
  description String?
  closingDate DateTime?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  questions   ApplicationQuestion[]
  responses   ApplicationResponse[]

  @@index([programId])
  @@index([programId, year, type])
}

model ApplicationQuestion {
  id            Int                     @id @default(autoincrement())
  application   Application             @relation(fields: [applicationId], references: [id])
  applicationId String
  parent        ApplicationQuestion?    @relation("QuestionChildren", fields: [parentId], references: [id])
  parentId      Int?
  children      ApplicationQuestion[]   @relation("QuestionChildren")
  order         Int
  type          String
  text          String
  required      Boolean?
  accept        String?
  maxFiles      Int?

  options       ApplicationQuestionOption[]
  answers       ApplicationAnswer[]

  @@index([applicationId])
  @@index([parentId])
}

model ApplicationQuestionOption {
  id         Int                 @id @default(autoincrement())
  question   ApplicationQuestion @relation(fields: [questionId], references: [id])
  questionId Int
  value      String
  order      Int

  @@index([questionId])
}

model ApplicationResponse {
  id String @id @default(cuid())
  application Application @relation(fields: [applicationId], references: [id])
  applicationId String
  status String @default("pending")
  createdAt DateTime @default(now())
  answers ApplicationAnswer[]

  @@index([applicationId])
}

model ApplicationAnswer {
  id Int @id @default(autoincrement())
  response ApplicationResponse @relation(fields: [responseId], references: [id])
  responseId String
  question ApplicationQuestion @relation(fields: [questionId], references: [id])
  questionId Int
  value Json

  @@index([responseId])
  @@index([questionId])
}
